kind: pipeline
name: default

steps:
- name: test
  image: golang:latest
  environment:
    LDAP_SERVER: "openldap"
    LDAP_PORT: "389"
    LDAP_BIND_DN: "uid=gitea,ou=service,dc=planetexpress,dc=com"
    LDAP_BIND_PASS: "password"
    LDAP_USER_BASE_DN: "ou=people,dc=planetexpress,dc=com"
    LDAP_USER_SEARCH_ATTR: "uid"
    LDAP_GROUP_BASE_DN: "ou=people,dc=planetexpress,dc=com"
    LDAP_GROUP_OBJECT_CLASS: "Group"
    LDAP_GROUP_SEARCH_ATTR: "member"
    LDAP_GROUP_SEARCH_FULL: "false"
    LDAP_TEST_USER: "professor"
    LDAP_TEST_PASSWORD: "professor"
  commands:
  - go version
  - go env
  - go test -v -coverprofile=coverage.txt -covermode=atomic ./...
  - cat ./coverage.txt
  - ls -la /drone/src

- name: coverage
  image: plugins/codecov
  settings: 
    token:
      from_secret: CODECOV_TOKEN
    files:
    - coverage.txt

services:
- name: openldap
  image: gitea/test-openldap:latest
  ports:
  - 389
  - 636
